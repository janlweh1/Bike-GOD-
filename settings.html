<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - Bike Rental Management System</title>
    <link rel="stylesheet" href="settings.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <h2>BikeRental</h2>
        </div>
        <nav class="nav-menu">
            <a href="dashboard.html" class="nav-item">
                <span class="icon"><img src="dashboard.png"></span>
                <span>Dashboard</span>
            </a>
            <a href="1.html" class="nav-item">
                <span class="icon"><img src="bike-moving.png"></span>
                <span>Bikes</span>
            </a>
            <a href="customers.html" class="nav-item">
                <span class="icon"><img src="users.png"></span>
                <span>Customers</span>
            </a>
            <a href="rentals.html" class="nav-item">
                <span class="icon"><img src="list.png"></span>
                <span>Rentals</span>
            </a>
            <a href="payments.html" class="nav-item">
                <span class="icon"><img src="wallet-arrow.png"></span>
                <span>Payments</span>
            </a>    
            <a href="settings.html" class="nav-item active">
                <span class="icon"><img src="settings.png"></span>
                <span>Settings</span>
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="search-bar">
                <input type="text" placeholder="Search settings...">
            </div>
            <div class="header-right">
                <button class="notification-btn"><img src="bell.png"></button>
                <div class="user-profile">
                    <img src="profuser.png" id="headerProfileImage">
                    <span id="headerUserName">Admin</span>
                </div>
            </div>
        </header>

        <!-- Settings Content -->
        <div class="settings-content">
            <div class="page-header">
                <h1>Settings</h1>
            </div>

            <!-- Settings Navigation -->
            <div class="settings-nav">
                <button class="settings-tab active" data-tab="profile">Admin Profile</button>
                <button class="settings-tab" data-tab="general">General</button>
                <button class="settings-tab" data-tab="business">Business Info</button>
                <button class="settings-tab" data-tab="pricing">Pricing & Rates</button>
                <button class="settings-tab" data-tab="notifications">Notifications</button>
                <button class="settings-tab" data-tab="security">Security</button>
                <button class="settings-tab" data-tab="about">About System</button>
            </div>

            <!-- Admin Profile Section -->
            <div class="settings-section active" id="profile">
                <div class="section-header">
                    <h2>Admin Profile</h2>
                    <p>Manage your administrator account information</p>
                </div>

                <div class="settings-card">
                    <h3>Profile Picture</h3>
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div class="profile-image-container">
                            <img id="profileImage" src="profuser.png" alt="Admin Profile">
                            <div class="profile-name-overlay" id="profileNameOverlay">JD</div>
                        </div>
                        <div>
                            <!-- Hidden file input -->
                            <input type="file" id="photoUpload" accept="image/*" style="display: none;">
                            <button class="secondary-btn" onclick="document.getElementById('photoUpload').click()">Upload New Photo</button>
                            <button class="secondary-btn" onclick="removePhoto()">Remove Photo</button>
                            <p style="font-size: 12px; color: #7f8c8d; margin-top: 8px;">Recommended: Square image, at least 200x200px</p>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Personal Information</h3>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="fullName" value="System Administrator" placeholder="Enter full name">
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="adminUsername" value="admin" placeholder="Enter username">
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <input type="text" id="adminRole" value="Super Admin" readonly style="background-color: #f5f5f5;">
                    </div>
                    <button class="secondary-btn" onclick="savePersonalInfo()">Save Changes</button>
                </div>

                <div class="settings-card">
                    <h3>Change Password</h3>
                    <div class="form-group">
                        <label>Current Password</label>
                        <input type="password" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label>New Password</label>
                        <input type="password" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label>Confirm New Password</label>
                        <input type="password" placeholder="Confirm new password">
                    </div>
                    <button class="secondary-btn" onclick="updatePassword()">Update Password</button>
                </div>

                <div class="settings-card">
                    <h3>Account Activity</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Last Login:</span>
                            <span class="info-value">Dec 26, 2025 10:30 AM</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Account Created:</span>
                            <span class="info-value">Jan 15, 2024</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Total Logins:</span>
                            <span class="info-value">1,234</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Status:</span>
                            <span class="info-value" style="color: #27ae60;">Active</span>
                        </div>
                    </div>
                </div>

            </div>

            <!-- General Settings -->
            <div class="settings-section" id="general">
                <div class="section-header">
                    <h2>General Settings</h2>
                    <p>Configure basic system settings</p>
                </div>

                <div class="settings-card">
                    <h3>System Configuration</h3>
                    <div class="form-group">
                        <label>System Name</label>
                        <input type="text" value="BikeRental Management System" placeholder="Enter system name">
                    </div>
                    <div class="form-group">
                        <label>Language</label>
                        <select>
                            <option value="en">English</option>
                            <option value="fil">Filipino</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Timezone</label>
                        <select>
                            <option value="asia/manila" selected>Asia/Manila (GMT+8)</option>
                            <option value="utc">UTC</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date Format</label>
                        <select>
                            <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                            <option value="dd/mm/yyyy" selected>DD/MM/YYYY</option>
                            <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Currency</label>
                        <select>
                            <option value="php" selected>Philippine Peso (‚Ç±)</option>
                            <option value="usd">US Dollar ($)</option>
                        </select>
                    </div>
                    <button class="secondary-btn" onclick="saveGeneralSettings()">Save Changes</button>
                </div>

                <div class="settings-card">
                    <h3>Rental Settings</h3>
                    <div class="form-group">
                        <label>Minimum Rental Period</label>
                        <select>
                            <option value="1" selected>1 Hour</option>
                            <option value="4">4 Hours</option>
                            <option value="24">1 Day</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Maximum Rental Period</label>
                        <input type="number" value="30" placeholder="Days">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto-late" checked>
                        <label for="auto-late">Automatically mark rentals as overdue</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="require-deposit" checked>
                        <label for="require-deposit">Require security deposit</label>
                    </div>
                    <button class="secondary-btn" onclick="saveRentalSettings()">Save Rental Settings</button>
                </div>
            </div>

            <!-- Business Info -->
            <div class="settings-section" id="business">
                <div class="section-header">
                    <h2>Business Information</h2>
                    <p>Manage your business details and contact information</p>
                </div>

                <div class="settings-card">
                    <h3>Company Details</h3>
                    <div class="form-group">
                        <label>Business Name</label>
                        <input type="text" value="BikeRental Inc." placeholder="Enter business name">
                    </div>
                    <div class="form-group">
                        <label>Business Address</label>
                        <textarea rows="3" placeholder="Enter complete address">123 Bike Street, Manila, Metro Manila, Philippines 1000</textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" value="+63 912 345 6789" placeholder="Enter phone">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" value="info@bikerental.com" placeholder="Enter email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" value="www.bikerental.com" placeholder="Enter website">
                        </div>
                        <div class="form-group">
                            <label>Tax ID / TIN</label>
                            <input type="text" value="123-456-789-000" placeholder="Enter TIN">
                        </div>
                    </div>
                    <button class="secondary-btn" onclick="saveBusinessInfo()">Save Business Info</button>
                </div>

                <div class="settings-card">
                    <h3>Operating Hours</h3>
                    <div class="operating-hours">
                        <div class="hour-row">
                            <span class="day">Monday - Friday</span>
                            <input type="time" value="08:00">
                            <span>to</span>
                            <input type="time" value="18:00">
                        </div>
                        <div class="hour-row">
                            <span class="day">Saturday</span>
                            <input type="time" value="09:00">
                            <span>to</span>
                            <input type="time" value="17:00">
                        </div>
                        <div class="hour-row">
                            <span class="day">Sunday</span>
                            <input type="time" value="10:00">
                            <span>to</span>
                            <input type="time" value="16:00">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Pricing & Rates -->
            <div class="settings-section" id="pricing">
                <div class="section-header">
                    <h2>Pricing & Rates</h2>
                    <p>Configure rental rates and pricing policies</p>
                </div>

                <div class="settings-card">
                    <h3>Default Rental Rates</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bike ID</th>
                                    <th>Model</th>
                                    <th>Type</th>
                                    <th>Hourly Rate</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bikeRatesBody">
                                <tr><td colspan="5">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Additional Charges</h3>
                    <div class="form-group">
                        <label>Late Fee (per day)</label>
                        <input type="number" value="200" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <label>Damage Fee (minimum)</label>
                        <input type="number" value="1000" placeholder="Amount">
                    </div>
                    <div class="form-group">
                        <label>Security Deposit</label>
                        <input type="number" value="2000" placeholder="Amount">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="tax-inclusive" checked>
                        <label for="tax-inclusive">Prices are tax-inclusive</label>
                    </div>
                    <button class="secondary-btn" onclick="saveCharges()">Save Charges</button>
                </div>
                
            </div>

            <!-- Notifications -->
            <div class="settings-section" id="notifications">
                <div class="section-header">
                    <h2>Notification Settings</h2>
                    <p>Manage notification preferences</p>
                </div>

                <div class="settings-card">
                    <h3>Email Notifications</h3>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="email-new-rental" checked>
                        <label for="email-new-rental">New rental created</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="email-rental-completed" checked>
                        <label for="email-rental-completed">Rental completed</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="email-overdue" checked>
                        <label for="email-overdue">Rental overdue</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="email-payment" checked>
                        <label for="email-payment">Payment received</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="email-new-customer">
                        <label for="email-new-customer">New customer registered</label>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>SMS Notifications</h3>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="sms-rental-reminder" checked>
                        <label for="sms-rental-reminder">Rental return reminder</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="sms-overdue" checked>
                        <label for="sms-overdue">Overdue notification</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="sms-payment">
                        <label for="sms-payment">Payment confirmation</label>
                    </div>
                </div>

                <div class="settings-card">
                    <h3>Reminder Settings</h3>
                    <div class="form-group">
                        <label>Send return reminder before</label>
                        <select>
                            <option value="1">1 Hour</option>
                            <option value="3">3 Hours</option>
                            <option value="12" selected>12 Hours</option>
                            <option value="24">24 Hours</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="settings-section" id="security">
                <div class="section-header">
                    <h2>Security Settings</h2>
                    <p>Manage security and access control</p>
                </div>

                <div class="settings-card">
                    <h3>Admin Account</h3>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" value="admin" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" value="admin@bikerental.com">
                    </div>
                    <button class="secondary-btn" onclick="openSecurityPassword()">Change Password</button>
                </div>

                <div class="settings-card">
                    <h3>Security Options</h3>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="two-factor" checked>
                        <label for="two-factor">Enable two-factor authentication</label>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="login-notification" checked>
                        <label for="login-notification">Send notification on login</label>
                    </div>
                    <div class="form-group">
                        <label>Session Timeout</label>
                        <select>
                            <option value="15">15 Minutes</option>
                            <option value="30" selected>30 Minutes</option>
                            <option value="60">1 Hour</option>
                            <option value="120">2 Hours</option>
                        </select>
                    </div>
                    <button class="secondary-btn" onclick="saveSecuritySettings()">Save Security Settings</button>
                </div>
            </div>

            <!-- About System -->
            <div class="settings-section" id="about">
                <div class="section-header">
                    <h2>About the System</h2>
                    <p>Information about BikeRental Management System</p>
                </div>

                <div class="settings-card about-card">
                    <div class="about-logo">
                        <div class="logo-circle">üö¥</div>
                        <h2>BikeRental Management System</h2>
                        <p class="version">Version 1.0.0</p>
                    </div>

                    <div class="about-section">
                        <h3>About Us</h3>
                        <p>BikeRental Management System is a comprehensive solution designed to streamline bike rental operations. Our system helps businesses manage their fleet, customers, rentals, and payments efficiently in one unified platform.</p>
                    </div>

                    <div class="about-section">
                        <h3>Key Features</h3>
                        <ul class="feature-list">
                            <li>üìä Real-time Dashboard & Analytics</li>
                            <li>üö¥ Complete Bike Fleet Management</li>
                            <li>üë• Customer Relationship Management</li>
                            <li>üìã Rental Tracking & Management</li>
                            <li>üí≥ Payment Processing & Tracking</li>
                            <li>üìà Comprehensive Reporting Tools</li>
                            <li>‚öôÔ∏è Customizable Settings & Configuration</li>
                            <li>üîí Secure Data Management</li>
                        </ul>
                    </div>

                    <div class="about-section">
                        <h3>System Information</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Version:</span>
                                <span class="info-value">1.0.0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Release Date:</span>
                                <span class="info-value">December 2025</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">License:</span>
                                <span class="info-value">Commercial License</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Developer:</span>
                                <span class="info-value">BikeRental Team</span>
                            </div>
                        </div>
                    </div>

                    <div class="about-section">
                        <h3>Support & Contact</h3>
                        <div class="contact-info">
                            <div class="contact-item">
                                <span class="contact-icon">üìß</span>
                                <div>
                                    <div class="contact-label">Email Support</div>
                                    <div class="contact-value">support@bikerental.com</div>
                                </div>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">üìû</span>
                                <div>
                                    <div class="contact-label">Phone Support</div>
                                    <div class="contact-value">+63 912 345 6789</div>
                                </div>
                            </div>
                            <div class="contact-item">
                                <span class="contact-icon">üåê</span>
                                <div>
                                    <div class="contact-label">Website</div>
                                    <div class="contact-value">www.bikerental.com</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="about-footer">
                        <p>¬© 2025 BikeRental Management System. All rights reserved.</p>
                        <div class="about-links">
                            <a href="#">Terms of Service</a>
                            <a href="#">Privacy Policy</a>
                            <a href="#">Documentation</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize settings data from backend and name display
        window.addEventListener('DOMContentLoaded', function() {
            loadAdminFromBackend();
            updateNameDisplay();
        });

        // Tab switching functionality
        document.querySelectorAll('.settings-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Remove active class from all tabs and sections
                document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding section
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Function to get initials from full name
        function getInitialsFromFullName(fullName) {
            const parts = fullName.trim().split(/\s+/);
            const first = parts[0] ? parts[0][0].toUpperCase() : '';
            const last = parts.length > 1 ? parts[parts.length - 1][0].toUpperCase() : '';
            return (first + last) || 'A';
        }

        // Function to update name display
        function updateNameDisplay() {
            const fullName = document.getElementById('fullName').value || 'Admin';
            const initials = getInitialsFromFullName(fullName);
            document.getElementById('profileNameOverlay').textContent = initials;
            document.getElementById('headerUserName').textContent = fullName;
        }

        // Save personal info function
        async function savePersonalInfo() {
            const fullName = document.getElementById('fullName').value.trim();
            const username = document.getElementById('adminUsername').value.trim();
            if (!fullName || !username) {
                alert('Please enter full name and username.');
                return;
            }
            try {
                const res = await fetch('update_admin_profile.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ full_name: fullName, username })
                });
                const data = await res.json();
                if (!data.success) throw new Error('Update failed');
                updateNameDisplay();
                alert('Personal information saved successfully!');
            } catch (e) {
                alert('Failed to save profile.');
            }
        }

        // Update name display when inputs change
        document.getElementById('fullName').addEventListener('input', updateNameDisplay);

        // Photo upload functionality
        document.getElementById('photoUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // Check if file is an image
                if (!file.type.startsWith('image/')) {
                    alert('Please select an image file.');
                    return;
                }
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB.');
                    return;
                }
                
                // Create a FileReader to read the image
                const reader = new FileReader();
                reader.onload = function(event) {
                    // Update the profile images
                    document.getElementById('profileImage').src = event.target.result;
                    document.getElementById('headerProfileImage').src = event.target.result;
                    // Hide the name overlay when custom photo is uploaded
                    document.getElementById('profileNameOverlay').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        });

        // Remove photo functionality
        function removePhoto() {
            if (confirm('Are you sure you want to remove your profile photo?')) {
                // Reset to default profile image
                document.getElementById('profileImage').src = 'profuser.png';
                document.getElementById('headerProfileImage').src = 'profuser.png';
                // Show the name overlay again
                document.getElementById('profileNameOverlay').style.display = 'flex';
                // Clear the file input
                document.getElementById('photoUpload').value = '';
            }
        }

        async function loadAdminFromBackend() {
            try {
                const res = await fetch('get_admin_settings.php');
                const data = await res.json();
                if (!data.success) return;
                const a = data.admin;
                document.getElementById('fullName').value = a.full_name || 'Admin';
                document.getElementById('adminUsername').value = a.username || 'admin';
                document.getElementById('adminRole').value = a.role || '';
                updateNameDisplay();
            } catch {}
        }

        // Update password (Profile section)
        async function updatePassword() {
            const inputs = document.querySelectorAll('#profile .settings-card input[type="password"]');
            const current = inputs[0].value.trim();
            const next = inputs[1].value.trim();
            const confirmNext = inputs[2].value.trim();
            if (!current || !next || !confirmNext) {
                alert('Please complete all password fields.');
                return;
            }
            if (next.length < 8) {
                alert('New password must be at least 8 characters.');
                return;
            }
            if (next !== confirmNext) {
                alert('New password and confirmation do not match.');
                return;
            }
            if (next === current) {
                alert('New password must differ from current password.');
                return;
            }
            try {
                const res = await fetch('update_admin_password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: current, new_password: next })
                });
                const data = await res.json();
                if (!data.success) {
                    if (data.error === 'wrong_current_password') alert('Current password is incorrect.');
                    else alert('Failed to update password.');
                    return;
                }
                alert('Password updated successfully!');
                inputs.forEach(i => i.value = '');
            } catch (e) {
                alert('Failed to update password.');
            }
        }

        // Save General settings
        function saveGeneralSettings() {
            const section = document.getElementById('general');
            const systemName = section.querySelector('input[placeholder="Enter system name"]').value.trim();
            const language = section.querySelector('select').value;
            const timezone = section.querySelectorAll('select')[1].value;
            const dateFormat = section.querySelectorAll('select')[2].value;
            const currency = section.querySelectorAll('select')[3].value;
            const settings = getSettings();
            settings.general = { systemName, language, timezone, dateFormat, currency };
            setSettings(settings);
            alert('General settings saved.');
        }

        // Save Rental settings
        function saveRentalSettings() {
            const section = document.getElementById('general');
            const minPeriod = section.querySelector('select option[value="1"]').selected ? 1 : (section.querySelector('select option[value="4"]').selected ? 4 : 24);
            const maxDays = parseInt(section.querySelector('input[placeholder="Days"]').value, 10) || 0;
            const autoLate = document.getElementById('auto-late').checked;
            const requireDeposit = document.getElementById('require-deposit').checked;
            const settings = getSettings();
            settings.rental = { minPeriod, maxDays, autoLate, requireDeposit };
            setSettings(settings);
            alert('Rental settings saved.');
        }

        // Save Business Info
        function saveBusinessInfo() {
            const section = document.getElementById('business');
            const name = section.querySelector('input[placeholder="Enter business name"]').value.trim();
            const address = section.querySelector('textarea').value.trim();
            const phone = section.querySelector('input[type="tel"]').value.trim();
            const email = section.querySelector('input[type="email"]').value.trim();
            const website = section.querySelector('input[type="url"]').value.trim();
            const tin = section.querySelector('input[placeholder="Enter TIN"]').value.trim();
            const hourRows = section.querySelectorAll('.hour-row');
            const hours = {
                weekdays: { from: hourRows[0].querySelectorAll('input')[0].value, to: hourRows[0].querySelectorAll('input')[1].value },
                saturday: { from: hourRows[1].querySelectorAll('input')[0].value, to: hourRows[1].querySelectorAll('input')[1].value },
                sunday: { from: hourRows[2].querySelectorAll('input')[0].value, to: hourRows[2].querySelectorAll('input')[1].value },
            };
            const settings = getSettings();
            settings.business = { name, address, phone, email, website, tin, hours };
            setSettings(settings);
            alert('Business information saved.');
        }

        // Save only Charges (kept local for now)
        function saveCharges() {
            const section = document.getElementById('pricing');
            // Charges card is the second card in the pricing section
            const chargesCard = section.querySelectorAll('.settings-card')[1];
            const lateFee = parseFloat(chargesCard.querySelectorAll('input')[0].value) || 0;
            const damageFee = parseFloat(chargesCard.querySelectorAll('input')[1].value) || 0;
            const deposit = parseFloat(chargesCard.querySelectorAll('input')[2].value) || 0;
            const taxInclusive = document.getElementById('tax-inclusive').checked;
            const s = getSettings();
            s.pricing = s.pricing || {};
            s.pricing.charges = { lateFee, damageFee, deposit, taxInclusive };
            setSettings(s);
            alert('Charges saved.');
        }

        // Save Security settings
        function saveSecuritySettings() {
            const section = document.getElementById('security');
            const email = section.querySelector('input[type="email"]').value.trim();
            const twoFactor = document.getElementById('two-factor').checked;
            const loginNotification = document.getElementById('login-notification').checked;
            const sessionTimeout = section.querySelector('select').value;
            const settings = getSettings();
            settings.security = { email, twoFactor, loginNotification, sessionTimeout };
            setSettings(settings);
            alert('Security settings saved.');
        }

        // Open security password change (redirect to Profile section)
        function openSecurityPassword() {
            document.querySelector('.settings-tab[data-tab="profile"]').click();
            const profileSection = document.getElementById('profile');
            profileSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Disable Notifications interactions
        function disableNotifications() {
            const section = document.getElementById('notifications');
            section.querySelectorAll('input, select, button').forEach(el => {
                el.disabled = true;
            });
            const banner = document.createElement('div');
            banner.style.background = '#fff3cd';
            banner.style.color = '#856404';
            banner.style.padding = '12px 16px';
            banner.style.border = '1px solid #ffeeba';
            banner.style.borderRadius = '8px';
            banner.style.margin = '0 0 16px 0';
            banner.textContent = 'Notifications settings are not available yet.';
            section.insertBefore(banner, section.firstChild);
        }

        // Persistence helpers
        function getSettings() {
            try { return JSON.parse(localStorage.getItem('adminSettings')) || {}; } catch { return {}; }
        }
        function setSettings(obj) {
            localStorage.setItem('adminSettings', JSON.stringify(obj));
        }

        // Load saved settings on start
        async function loadSavedSettings() {
            const s = getSettings();
            // General
            if (s.general) {
                const section = document.getElementById('general');
                section.querySelector('input[placeholder="Enter system name"]').value = s.general.systemName || section.querySelector('input[placeholder="Enter system name"]').value;
                section.querySelector('select').value = s.general.language || section.querySelector('select').value;
                section.querySelectorAll('select')[1].value = s.general.timezone || section.querySelectorAll('select')[1].value;
                section.querySelectorAll('select')[2].value = s.general.dateFormat || section.querySelectorAll('select')[2].value;
                section.querySelectorAll('select')[3].value = s.general.currency || section.querySelectorAll('select')[3].value;
            }
            if (s.rental) {
                const section = document.getElementById('general');
                // minPeriod select
                const select = section.querySelectorAll('select')[0];
                Array.from(select.options).forEach(opt => opt.selected = false);
                const val = String(s.rental.minPeriod || 1);
                const targetOpt = Array.from(select.options).find(o => o.value === val);
                if (targetOpt) targetOpt.selected = true;
                section.querySelector('input[placeholder="Days"]').value = s.rental.maxDays ?? section.querySelector('input[placeholder="Days"]').value;
                document.getElementById('auto-late').checked = !!s.rental.autoLate;
                document.getElementById('require-deposit').checked = !!s.rental.requireDeposit;
            }
            // Business
            if (s.business) {
                const section = document.getElementById('business');
                section.querySelector('input[placeholder="Enter business name"]').value = s.business.name || section.querySelector('input[placeholder="Enter business name"]').value;
                section.querySelector('textarea').value = s.business.address || section.querySelector('textarea').value;
                section.querySelector('input[type="tel"]').value = s.business.phone || section.querySelector('input[type="tel"]').value;
                section.querySelector('input[type="email"]').value = s.business.email || section.querySelector('input[type="email"]').value;
                section.querySelector('input[type="url"]').value = s.business.website || section.querySelector('input[type="url"]').value;
                section.querySelector('input[placeholder="Enter TIN"]').value = s.business.tin || section.querySelector('input[placeholder="Enter TIN"]').value;
                const hourRows = section.querySelectorAll('.hour-row');
                if (s.business.hours) {
                    hourRows[0].querySelectorAll('input')[0].value = s.business.hours.weekdays?.from || hourRows[0].querySelectorAll('input')[0].value;
                    hourRows[0].querySelectorAll('input')[1].value = s.business.hours.weekdays?.to || hourRows[0].querySelectorAll('input')[1].value;
                    hourRows[1].querySelectorAll('input')[0].value = s.business.hours.saturday?.from || hourRows[1].querySelectorAll('input')[0].value;
                    hourRows[1].querySelectorAll('input')[1].value = s.business.hours.saturday?.to || hourRows[1].querySelectorAll('input')[1].value;
                    hourRows[2].querySelectorAll('input')[0].value = s.business.hours.sunday?.from || hourRows[2].querySelectorAll('input')[0].value;
                    hourRows[2].querySelectorAll('input')[1].value = s.business.hours.sunday?.to || hourRows[2].querySelectorAll('input')[1].value;
                }
            }
            // Pricing: rates are shown via the table below; loaded in loadBikeRates()
            // Charges remain local-only for now
            if (s.pricing) {
                const section = document.getElementById('pricing');
                const chargesCard = section.querySelectorAll('.settings-card')[1];
                if (s.pricing.charges) {
                    chargesCard.querySelectorAll('input')[0].value = s.pricing.charges.lateFee ?? chargesCard.querySelectorAll('input')[0].value;
                    chargesCard.querySelectorAll('input')[1].value = s.pricing.charges.damageFee ?? chargesCard.querySelectorAll('input')[1].value;
                    chargesCard.querySelectorAll('input')[2].value = s.pricing.charges.deposit ?? chargesCard.querySelectorAll('input')[2].value;
                    document.getElementById('tax-inclusive').checked = !!s.pricing.charges.taxInclusive;
                }
            }
            // Security
            if (s.security) {
                const section = document.getElementById('security');
                section.querySelector('input[type="email"]').value = s.security.email ?? section.querySelector('input[type="email"]').value;
                document.getElementById('two-factor').checked = !!s.security.twoFactor;
                document.getElementById('login-notification').checked = !!s.security.loginNotification;
                section.querySelector('select').value = s.security.sessionTimeout ?? section.querySelector('select').value;
            }
            // Load per-bike rates
            await loadBikeRates();
        }

        // Boot
        window.addEventListener('DOMContentLoaded', () => {
            loadSavedSettings();
            disableNotifications();
        });

        // Simple HTML escaping to prevent injection in dynamic content
        function escapeHtml(str) {
            return String(str).replace(/[&<>"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
        }

        // Helper to flatten backend error objects/arrays into readable text
        function describeBackendError(data) {
            if (!data || typeof data !== 'object') return '';
            let msg = '';
            if (data.error) msg = String(data.error);
            if (data.detail) {
                try {
                    if (Array.isArray(data.detail)) {
                        const parts = data.detail.map(e => {
                            const state = e.SQLSTATE || e.sqlstate || '';
                            const code = e.code || e.SQLCODE || '';
                            const text = e.message || e.Message || '';
                            return [state, code, text].filter(Boolean).join(' ');
                        }).filter(Boolean);
                        if (parts.length) msg += (msg ? ' ' : '') + parts.join('; ');
                    } else if (typeof data.detail === 'string') {
                        msg += (msg ? ' ' : '') + data.detail;
                    } else {
                        msg += (msg ? ' ' : '') + JSON.stringify(data.detail);
                    }
                } catch {}
            }
            return msg.trim();
        }

        async function loadBikeRates() {
            const tbody = document.getElementById('bikeRatesBody');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            try {
                const res = await fetch('get_bikes.php');
                const data = await res.json();
                if (!data.success) {
                    const detail = describeBackendError(data);
                    tbody.innerHTML = `<tr><td colspan="5">Failed to load bikes${detail ? ': ' + escapeHtml(detail) : ''}.</td></tr>`;
                    return;
                }
                tbody.innerHTML = '';
                data.bikes.forEach(b => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${b.id}</td>
                        <td>${escapeHtml(b.model || '')}</td>
                        <td>${escapeHtml(b.type || '')}</td>
                        <td><input type="number" step="0.01" min="0" value="${b.hourly_rate}" data-bike-id="${b.id}" style="width:120px"></td>
                        <td><button class="secondary-btn" onclick="saveBikeRate(${b.id})">Save</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error('Failed to load bike rates', e);
                tbody.innerHTML = `<tr><td colspan="5">Failed to load bikes: ${escapeHtml(e.message || 'unknown error')}</td></tr>`;
            }
        }


        async function saveBikeRate(bikeId) {
            const input = document.querySelector(`input[data-bike-id='${bikeId}']`);
            const rate = parseFloat(input.value);
            if (isNaN(rate) || rate < 0) {
                alert('Please enter a valid hourly rate.');
                return;
            }
            try {
                const res = await fetch('update_bike_rate.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bike_id: bikeId, rate })
                });
                const data = await res.json();
                if (!data.success) {
                    let msg = data.error ? `Failed to update: ${data.error}` : 'Failed to update rate.';
                    if (data.detail) {
                        try {
                            const err = Array.isArray(data.detail) ? data.detail.map(e => e.message || '').join('\n') : JSON.stringify(data.detail);
                            if (err) msg += `\nDetails: ${err}`;
                        } catch {}
                    }
                    alert(msg);
                    return;
                }
                alert('Rate updated successfully.');
            } catch (e) {
                console.error('Update rate exception', e);
                alert('Failed to update rate.');
            }
        }
    </script>
</body>
</html>